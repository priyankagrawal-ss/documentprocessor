<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings xmlns="https://jakarta.ee/xml/ns/persistence/orm"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="https://jakarta.ee/xml/ns/persistence/orm https://jakarta.ee/xml/ns/persistence/orm/orm_3_0.xsd"
                 version="3.0">
    <named-native-query name="DocumentProcessingView.findStatusMetricsByBucketIds.native"
                        result-set-mapping="StatusMetricMapping">
        <query>
            <![CDATA[
                WITH
                -------------------------------------------------------------------
                -- CTE 1: Gather and pre-aggregate status data for the requested buckets.
                -- This combines data retrieval and initial counting in a single step.
                -------------------------------------------------------------------
                document_counts AS (
                    -- GroundX statuses (final stage)
                    SELECT
                        gm.gx_bucket_id,
                        CASE gm.gx_status
                            WHEN 'COMPLETE'           THEN 'Completed (GroundX)'
                            WHEN 'ACTIVE'             THEN 'Active (GroundX)'
                            WHEN 'IN_ACTIVE'          THEN 'Inactive (GroundX)'
                            WHEN 'SKIPPED'            THEN 'Skipped (GroundX)'
                            WHEN 'QUEUED_FOR_UPLOAD'  THEN 'Queued for Upload (GroundX)'
                            WHEN 'QUEUED'             THEN 'Queued (GroundX)'
                            WHEN 'PROCESSING'         THEN 'Processing (GroundX)'
                            WHEN 'ERROR'              THEN 'Error (GroundX)'
                            WHEN 'CANCELLED'          THEN 'Cancelled (GroundX)'
                            WHEN 'TERMINATED'         THEN 'Terminated (GroundX)'
                            ELSE 'Unknown'
                        END AS display_status,
                        COUNT(*) AS status_count
                    FROM gx_master gm
                    WHERE gm.gx_bucket_id IN (:gxBucketIds)
                    GROUP BY gm.gx_bucket_id, gm.gx_status

                    UNION ALL

                    -- Ingestion statuses (for files not yet in GroundX)
                    SELECT
                        fm.gx_bucket_id,
                        CASE fm.file_processing_status
                            WHEN 'QUEUED'       THEN 'Queued (Ingestion)'
                            WHEN 'IN_PROGRESS'  THEN 'Processing (Ingestion)'
                            WHEN 'FAILED'       THEN 'Error (Ingestion)'
                            WHEN 'DUPLICATE'    THEN 'Duplicate (Ingestion)'
                            WHEN 'IGNORED'      THEN 'Ignored (Ingestion)'
                            WHEN 'TERMINATED'   THEN 'Terminated (Ingestion)'
                            ELSE 'Unknown'
                        END AS display_status,
                        COUNT(*) AS status_count
                    FROM file_master fm
                    WHERE
                        fm.gx_bucket_id IN (:gxBucketIds)
                        AND fm.file_processing_status != 'COMPLETED'
                        AND NOT EXISTS (
                            SELECT 1 FROM gx_master gm WHERE gm.source_file_id = fm.id
                        )
                    GROUP BY fm.gx_bucket_id, fm.file_processing_status
                )
                -------------------------------------------------------------------
                -- FINAL SELECT: Present the aggregated metrics and calculate the 'Total' row.
                -------------------------------------------------------------------
                -- Part 1: Select the individual status counts that were calculated in the CTE.
                SELECT
                    gx_bucket_id,
                    display_status,
                    status_count
                FROM document_counts

                UNION ALL

                -- Part 2: Calculate the 'Total' count for each bucket.
                -- The CAST is retained to prevent the data type mismatch issue.
                SELECT
                    gx_bucket_id,
                    'Total' AS display_status,
                    CAST(SUM(status_count) AS BIGINT) AS status_count
                FROM document_counts
                GROUP BY gx_bucket_id;
            ]]>
        </query>
    </named-native-query>

    <!-- The SqlResultSetMapping remains the same as it correctly maps the required columns -->
    <sql-result-set-mapping name="StatusMetricMapping">
        <constructor-result target-class="com.eyelevel.documentprocessor.dto.metric.StatusMetric">
            <column name="gx_bucket_id" class="java.lang.Integer"/>
            <column name="display_status" class="java.lang.String"/>
            <column name="status_count" class="java.lang.Long"/>
        </constructor-result>
    </sql-result-set-mapping>

</entity-mappings>